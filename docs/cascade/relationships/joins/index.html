<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-cascade/relationships/joins" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.3.2">
<title data-rh="true">Joins (Lookups) | Warlock.js</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://mentoor.io/logo.svg"><meta data-rh="true" name="twitter:image" content="https://mentoor.io/logo.svg"><meta data-rh="true" property="og:url" content="https://warlock.js.org/docs/cascade/relationships/joins"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Joins (Lookups) | Warlock.js"><meta data-rh="true" name="description" content="Joins mean data is fetched from two or more collections in one query, for example, fetching posts, each post has a user id, and we want to fetch the user data for each post."><meta data-rh="true" property="og:description" content="Joins mean data is fetched from two or more collections in one query, for example, fetching posts, each post has a user id, and we want to fetch the user data for each post."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://warlock.js.org/docs/cascade/relationships/joins"><link data-rh="true" rel="alternate" href="https://warlock.js.org/docs/cascade/relationships/joins" hreflang="en"><link data-rh="true" rel="alternate" href="https://warlock.js.org/docs/cascade/relationships/joins" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.f72f589a.css">
<script src="/assets/js/runtime~main.b156083d.js" defer="defer"></script>
<script src="/assets/js/main.e6d1dc1a.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="https://mentoor.io/logo.svg" alt="mentoor.io" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="https://mentoor.io/logo.svg" alt="mentoor.io" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Warlock.js EcoSystem</b></a><a class="navbar__item navbar__link" href="/docs/warlock/getting-started/introduction">Warlock</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/cascade/getting-started/introduction">Cascade</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hassanzohdy" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/getting-started-1">Getting Started</a><button aria-label="Expand sidebar category &#x27;Getting Started&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/queries">Queries</a><button aria-label="Expand sidebar category &#x27;Queries&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/models">Models</a><button aria-label="Expand sidebar category &#x27;Models&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/aggregation">Aggregation</a><button aria-label="Expand sidebar category &#x27;Aggregation&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/events">Events</a><button aria-label="Expand sidebar category &#x27;Events&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/indexing">Indexing</a><button aria-label="Expand sidebar category &#x27;Indexing&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/relationships">Relationships</a><button aria-label="Collapse sidebar category &#x27;Relationships&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cascade/relationships/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cascade/relationships/embedded-documents">Embedded Documents</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cascade/relationships/syncing-models">Syncing Models</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/cascade/relationships/joins">Joins (Lookups)</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/advanced-1">Advanced</a><button aria-label="Expand sidebar category &#x27;Advanced&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/relationships"><span itemprop="name">Relationships</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Joins (Lookups)</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1 id="joins-lookups">Joins (Lookups)</h1>
<p>Joins mean data is fetched from two or more collections in one query, for example, fetching posts, each post has a user id, and we want to fetch the user data for each post.</p>
<p>Or we may fetch multiple documents, for example, fetch comments when fetching posts.</p>
<p>This could be done in MongoDB using <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/lookup/">Lookups</a>.</p>
<p>But in Cascade, we have a better way to do it.</p>
<h2 id="the-joinings-method">The joinings method</h2>
<p>Any model has its own <a href="/docs/cascade/aggregate/model-aggregate">Aggregate model class</a>, the idea here is to make the code more readable and easier to maintain.</p>
<p>Let&#x27;s take an example of the basic lookup pipeline and see how we can transform it into a more readable code.</p>
<pre><code class="language-ts">import { Post } from &quot;./models/post&quot;;

const posts = await Post.aggregate()
  .lookup({
    from: &quot;comments&quot;,
    localField: &quot;id&quot;,
    foreignField: &quot;post.id&quot;,
    as: &quot;comments&quot;,
  })
  .get();
</code></pre>
<p>This will fetch all posts and join the user data for each post, which gives an output like this:</p>
<pre><code class="language-json">[
  {
    &quot;id&quot;: &quot;1&quot;,
    &quot;title&quot;: &quot;Post 1&quot;,
    &quot;createdBy&quot;: {
      &quot;id&quot;: &quot;2&quot;,
      &quot;name&quot;: &quot;User 1&quot;,
      &quot;image&quot;: &quot;path-to-image.jpg&quot;
    },
    &quot;comments&quot;: [
      {
        &quot;id&quot;: &quot;1&quot;,
        &quot;content&quot;: &quot;Comment 1&quot;,
        &quot;createdBy&quot;: {
          &quot;id&quot;: &quot;3&quot;,
          &quot;name&quot;: &quot;User 2&quot;,
          &quot;image&quot;: &quot;path-to-image.jpg&quot;
        }
      },
      {
        &quot;id&quot;: &quot;2&quot;,
        &quot;content&quot;: &quot;Comment 2&quot;,
        &quot;createdBy&quot;: {
          &quot;id&quot;: &quot;4&quot;,
          &quot;name&quot;: &quot;User 3&quot;,
          &quot;image&quot;: &quot;path-to-image.jpg&quot;
        }
      }
    ]
  }
]
</code></pre>
<h2 id="joinings">Joinings</h2>
<p>So the concept is simple, we define a list of static <code>joinings</code> in the model, each joining has a name, and a <code>Joinable</code> instance.</p>
<p>We have two types of joinings, the first one is we want to make a <a href="https://en.wikipedia.org/wiki/One-to-one_(data_model)">1-1 relationship</a> between the two collections, and the second one is we want to make a <a href="https://en.wikipedia.org/wiki/One-to-many_(data_model)">1-many relationship</a>.</p>
<p>Let&#x27;s see each one</p>
<h2 id="1-1-relationship">1-1 Relationship</h2>
<p>Let&#x27;s say we have a <code>Post</code> model, and we want to join the user data for each post, we can define a joining like this:</p>
<pre><code class="language-ts" metastring="title=&quot;src/models/post.ts&quot;">import { Model } from &quot;@warlock.js/cascade&quot;;
import { User } from &quot;./user&quot;;

export class Post extends Model {
  static collectionName = &quot;posts&quot;;

  /**
   * List of joinings
   */
  public static joinings = {
    author: User.joinable(&quot;createdBy.id&quot;, &quot;id&quot;).single().as(&quot;author&quot;),
  };
}
</code></pre>
<p>This will join the user data for each post, and the output will be like this:</p>
<pre><code class="language-json">[
  {
    &quot;id&quot;: &quot;1&quot;,
    &quot;title&quot;: &quot;Post 1&quot;,
    &quot;author&quot;: {
      &quot;id&quot;: &quot;2&quot;,
      &quot;name&quot;: &quot;User 1&quot;,
      &quot;image&quot;: &quot;path-to-image.jpg&quot;
    }
  }
]
</code></pre>
<p>As it performs a <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/lookup/">Lookup Pipeline</a>, it will return an array of documents, so we need to use the <code>single</code> method to tell The Joiner that we want to return only one document.</p>
<p>This will make a lookup object with the following properties:</p>
<pre><code class="language-json">{
  &quot;from&quot;: &quot;users&quot;,
  &quot;localField&quot;: &quot;createdBy.id&quot;,
  &quot;foreignField&quot;: &quot;id&quot;,
  &quot;as&quot;: &quot;author&quot;
}
</code></pre>
<h2 id="1-many-relationship">1-many Relationship</h2>
<p>Suppose we want to return list of comments for each post, we can define a joining like this:</p>
<pre><code class="language-ts" metastring="title=&quot;src/models/post.ts&quot;">import { Model } from &quot;@warlock.js/cascade&quot;;
import { Comment } from &quot;./comment&quot;;

export class Post extends Model {
  static collectionName = &quot;posts&quot;;

  /**
   * List of joinings
   */
  public static joinings = {
    comments: Comment.joinable(&quot;id&quot;, &quot;post.id&quot;),
  };
}
</code></pre>
<p>This will make a lookup object with the following properties:</p>
<pre><code class="language-json">{
  &quot;from&quot;: &quot;comments&quot;,
  &quot;localField&quot;: &quot;id&quot;,
  &quot;foreignField&quot;: &quot;post.id&quot;,
  &quot;as&quot;: &quot;comments&quot;
}
</code></pre>
<p>We can alternatively, use <code>localField</code> and <code>foreignField</code> properties to define the fields</p>
<pre><code class="language-ts" metastring="title=&quot;src/models/post.ts&quot;">import { Model } from &quot;@warlock.js/cascade&quot;;
import { User } from &quot;./user&quot;;
import { Comment } from &quot;./comment&quot;;

export class Post extends Model {
  static collectionName = &quot;posts&quot;;

  /**
   * List of joinings
   */
  public static joinings = {
    author: User.joinable()
      .single(true)
      .localField(&quot;createdBy.id&quot;)
      .foreignField(&quot;id&quot;),
    comments: Comment.joinable().localField(&quot;id&quot;).foreignField(&quot;post.id&quot;),
  };
}
</code></pre>
<p>Now let&#x27;s see how we can use it:</p>
<h2 id="using-joinings">Using Joinings</h2>
<p>To use any of these joinings in a <a href="/docs/cascade/aggregate/model-aggregate">Model Aggregate</a> query, we can use <code>joining</code> method which accepts two argument, the first one is the joining name or the <code>Joinable instance</code>, the second argument is the <code>options</code> object.</p>
<pre><code class="language-ts">import { Post } from &quot;./models/post&quot;;

const posts = await Post.aggregate()
  .joining(&quot;author&quot;)
  .joining(&quot;comments&quot;)
  .get();
</code></pre>
<p>We can refer to the reference of the joining directly from the static property <code>joinings</code>:</p>
<pre><code class="language-ts">import { Post } from &quot;./models/post&quot;;

const posts = await Post.aggregate()
  .joining(Post.joinings.author)
  .joining(Post.joinings.comments)
  .get();
</code></pre>
<p>The second solution gives you more flexibility and more typescript support.</p>
<h2 id="joining-options">Joining Options</h2>
<p>So now we saw how to perform a lookup using the <code>joining</code> method, but what if we want to customize the lookup options?</p>
<p>For example, let&#x27;s say we want to get only the approved comments with the post not all comments.</p>
<p>We can pass the options object as the second argument to the <code>joining</code> method:</p>
<pre><code class="language-ts">import { Post } from &quot;./models/post&quot;;

const posts = await Post.aggregate()
  .joining(&quot;author&quot;)
  .joining(&quot;comments&quot;)
  .get();
</code></pre>
<p>We may also define what to be selected from the joined collection:</p>
<pre><code class="language-ts">import { Post } from &quot;./models/post&quot;;

const posts = await Post.aggregate()
  .joining(&quot;author&quot;)
  .joining(&quot;comments&quot;, {
    where: {
      isApproved: true,
    },
    select: [&quot;id&quot;, &quot;content&quot;],
  })
  .get();
</code></pre>
<admonition type="tip"><p>These can also be done when declaring the joinings list, but sometimes we want to make more filter based on the current situation.</p></admonition>
<p>We can also use the <code>where</code> and <code>select</code> methods from the joining instance:</p>
<pre><code class="language-ts" metastring="{6}">import { Post } from &quot;./models/post&quot;;

const posts = await Post.aggregate()
  .joining(&quot;author&quot;)
  .joining(
    Post.joinings.comments.where({ isApproved: true }).select([&quot;id&quot;, &quot;content&quot;])
  )
  .joining()
  .get();
</code></pre>
<admonition title="Did you know?" type="info"><p>When using the <code>where</code> method from the joining instance, you can use any of the <a href="/docs/cascade/aggregate/filtering">where operators</a></p></admonition>
<h2 id="auto-detecting-fields">Auto Detecting Fields</h2>
<p>By default the <code>Joinable</code> class will set the local field to <code>id</code>.</p>
<p>Regarding <code>as</code> and <code>foreignField</code> properties, it will depend on the <code>single</code> type, if it set to <code>true</code>, then it will be the singular of the joining model <code>collection</code> value, otherwise it will be the plural of the joining model <code>collection</code> value.</p>
<p>And the foreign field will be the same as <code>as</code> but suffixed with <code>Id</code>.</p>
<p>Let&#x27;s see the both example, the first one if we provided all <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/lookup/">Lookup</a> options:</p>
<pre><code class="language-ts" metastring="title=&quot;src/models/post.ts&quot;">import { Model } from &quot;@warlock.js/cascade&quot;;
import { User } from &quot;./user&quot;;

export class Post extends Model {
  static collectionName = &quot;posts&quot;;

  /**
   * List of joinings
   */
  public static joinings = {
    author: User.joinable()
      .single(true)
      .localField(&quot;createdBy.id&quot;)
      .foreignField(&quot;id&quot;)
      .as(&quot;author&quot;),
  };
}
</code></pre>
<p>Now let&#x27;s see the second example, if we didn&#x27;t provide any options:</p>
<pre><code class="language-ts" metastring="title=&quot;src/models/post.ts&quot;">import { Model } from &quot;@warlock.js/cascade&quot;;
import { User } from &quot;./user&quot;;

export class Post extends Model {
  static collectionName = &quot;posts&quot;;

  /**
   * List of joinings
   */
  public static joinings = {
    author: User.joinable().single(true),
  };
}
</code></pre>
<p>This will be translated to:</p>
<pre><code class="language-ts">import { Model } from &quot;@warlock.js/cascade&quot;;
import { User } from &quot;./user&quot;;

export class Post extends Model {
  static collectionName = &quot;posts&quot;;

  /**
   * List of joinings
   */
  public static joinings = {
    author: User.joinable()
      .single(true)
      .localField(&quot;user.id&quot;)
      .foreignField(&quot;id&quot;)
      .as(&quot;user&quot;),
  };
}
</code></pre>
<p>It is pretty near to be accurate, but if the user that is stored in the <code>Post</code> model is <code>createdBy</code>, then we need to change the <code>localField</code> to <code>createdBy.id</code>:</p>
<p>You could also pass the four values as follows:</p>
<pre><code class="language-ts" metastring="title=&quot;src/models/post.ts&quot;">import { Model } from &quot;@warlock.js/cascade&quot;;
import { User } from &quot;./user&quot;;

export class Post extends Model {
  static collectionName = &quot;posts&quot;;

  /**
   * List of joinings
   */
  public static joinings = {
    author: User.joinable(&quot;createdBy.id&quot;, &quot;id&quot;, true, &quot;author&quot;),
  };
}
</code></pre>
<admonition type="tip"><p>calling <code>single</code> method with <strong>true</strong> value will only return one document, otherwise it will return list of documents from the joined collection, default value to <code>single</code> is <strong>false</strong>.</p></admonition>
<h2 id="counting-joined-documents">Counting Joined Documents</h2>
<p>Sometimes we just need to count the documents from the joined collection, for example we need to count total number of comments for each post, in that situation we can use the <code>countJoining</code> method:</p>
<pre><code class="language-ts">import { Post } from &quot;./models/post&quot;;

const posts = await Post.aggregate().countJoining(&quot;comments&quot;).get();
</code></pre>
<blockquote>
<p>Please note that the first and second argument of the <code>countJoining</code> method are the same as the <code>joining</code> method.</p>
</blockquote>
<p>This will return a new property called <code>commentsCount</code> for each post, if you want to set a custom name for the property, you can pass the <code>as</code> property in the options object:</p>
<pre><code class="language-ts">import { Post } from &quot;./models/post&quot;;

const posts = await Post.aggregate()
  .countJoining(&quot;comments&quot;, {
    as: &quot;totalComments&quot;,
  })
  .get();
</code></pre>
<h2 id="using-aggregate-pipeline">Using Aggregate pipeline</h2>
<p>So if we need to add more pipeline options to the joining (lookup) collection, we can use the second argument to the <code>joining</code> method, it receives a callback function which receives the <code>Joinable</code> instance for the joined collection, which we can use any <a href="./../aggregate/introduction">Aggregate</a> method on it.</p>
<h3 id="example">Example</h3>
<p>This will be the default setup to join comments for the post:</p>
<pre><code class="language-ts">import { Model } from &quot;@warlock.js/cascade&quot;;
import { Post } from &quot;./models/post&quot;;
import { Comment } from &quot;./models/comment&quot;;

export class Post extends Model {
  static collectionName = &quot;posts&quot;;

  /**
   * List of joinings
   */
  public static joinings = {
    comments: Comment.joinable(&quot;id&quot;, &quot;post.id&quot;),
  };
}
</code></pre>
<p>Now we can get all comments for the post like this:</p>
<pre><code class="language-ts">import { Post } from &quot;./models/post&quot;;

const posts = await Post.aggregate().joining(&quot;comments&quot;).get();
</code></pre>
<p>Or we can get only the approved comments:</p>
<pre><code class="language-ts">import { Post } from &quot;./models/post&quot;;

const posts = await Post.aggregate()
  .joining(&quot;comments&quot;, (query) =&gt; query.where(&quot;isApproved&quot;, true))
  .get();
</code></pre>
<admonition type="tip"><p>The query used here will be on the joined collection, which will be applied on the <code>comments</code> collection.</p></admonition>
<h2 id="advanced-examples">Advanced Examples</h2>
<p>We have <code>Post</code> model, represents <strong>posts collection</strong>, <code>Comment</code> model represents <strong>comments collection</strong> and <code>Like</code> model represents <strong>likes collection</strong>.</p>
<p>The <code>Like</code> model has two properties, <code>type</code> and <code>typeId</code>, so we can store inside it post and/or comment likes.</p>
<p>Let&#x27;s see how we can fetch the posts with the comments and likes count for each post:</p>
<pre><code class="language-ts" metastring="models/post.ts {11}">import { Model } from &quot;@warlock.js/cascade&quot;;
import { Like } from &quot;./like&quot;;
import { Comment } from &quot;./comment&quot;;

export class Post extends Model {
  static collectionName = &quot;posts&quot;;

  /**
   * List of joinings
   */
  public static joinings = {
    likes: Like.joinable(&quot;id&quot;, &quot;type.id&quot;).where(&quot;type&quot;, &quot;post&quot;),
    comments: Comment.joinable(&quot;id&quot;, &quot;post.id&quot;),
  };
}
</code></pre>
<pre><code class="language-ts" metastring="models/like.ts">import { Model, Casts } from &quot;@warlock.js/cascade&quot;;

export class Like extends Model {
  static collectionName = &quot;likes&quot;;

  /**
   * {@inheritDoc}
   */
  protected casts: Casts = {
    type: &quot;string&quot;,
    typeId: &quot;int&quot;,
  };
}
</code></pre>
<p>Now let&#x27;s count the comments and likes for each post:</p>
<pre><code class="language-ts">import { Post } from &quot;./models/post&quot;;

const posts = await Post.aggregate()
  .countJoining(&quot;likes&quot;)
  .countJoining(&quot;comments&quot;)
  .get();
</code></pre>
<p>This will return something like this: (I&#x27;m using <code>console.log</code> to make it more readable)</p>
<pre><code class="language-json">[
  {
    &quot;id&quot;: &quot;1&quot;,
    &quot;title&quot;: &quot;Post 1&quot;,
    &quot;likesCount&quot;: 2,
    &quot;commentsCount&quot;: 2
  }
]
</code></pre>
<h3 id="counting-likes-and-comments-for-only-current-user">Counting Likes and Comments for only current user</h3>
<p>Let&#x27;s say we want to count the likes and comments for only the current user, we can do it like this:</p>
<blockquote>
<p>We&#x27;ll assume any like or comment has a <code>createdBy</code> object of a <code>User</code> model.</p>
</blockquote>
<pre><code class="language-ts">import { Post } from &quot;./models/post&quot;;

const posts = await Post.aggregate()
  .countJoining(&quot;likes&quot;, query =&gt; query.where(&#x27;createdBy.id&#x27;, 1))
  .countJoining(&quot;comments&quot;, query =&gt; query.where(&quot;createdBy.id&quot;: 1))
  .get();
</code></pre>
<p>This will return something like this:</p>
<pre><code class="language-json">[
  {
    &quot;id&quot;: &quot;1&quot;,
    &quot;title&quot;: &quot;Post 1&quot;,
    &quot;likesCount&quot;: 1,
    &quot;commentsCount&quot;: 1
  }
]
</code></pre>
<p>In that scenario we only returned the likes and comments for the current user.</p>
<h3 id="get-total-likes-and-check-if-current-user-liked-the-post">Get total likes and check if current user liked the post</h3>
<p>Let&#x27;s say we want to get the total likes for each post, and check if the current user liked the post or not.</p>
<p>We can do it like this:</p>
<pre><code class="language-ts">import { $agg } from &quot;@warlock.js/cascade&quot;;
import { Post } from &quot;./models/post&quot;;

const posts = await Post.aggregate()
  .countJoining(&quot;likes&quot;)
  .joining(&quot;likes&quot;, join =&gt; join.where(&quot;createdBy.id&quot;, 1).single(true).as(&quot;userLike&quot;))
  .addField(&#x27;liked&#x27;, $agg.booleanCond($agg.eq(&quot;$userLike&quot;, null))
  .get();
</code></pre></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/cascade/relationships/syncing-models"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Syncing Models</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/advanced-1"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Advanced</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-joinings-method" class="table-of-contents__link toc-highlight">The joinings method</a></li><li><a href="#joinings" class="table-of-contents__link toc-highlight">Joinings</a></li><li><a href="#1-1-relationship" class="table-of-contents__link toc-highlight">1-1 Relationship</a></li><li><a href="#1-many-relationship" class="table-of-contents__link toc-highlight">1-many Relationship</a></li><li><a href="#using-joinings" class="table-of-contents__link toc-highlight">Using Joinings</a></li><li><a href="#joining-options" class="table-of-contents__link toc-highlight">Joining Options</a></li><li><a href="#auto-detecting-fields" class="table-of-contents__link toc-highlight">Auto Detecting Fields</a></li><li><a href="#counting-joined-documents" class="table-of-contents__link toc-highlight">Counting Joined Documents</a></li><li><a href="#using-aggregate-pipeline" class="table-of-contents__link toc-highlight">Using Aggregate pipeline</a><ul><li><a href="#example" class="table-of-contents__link toc-highlight">Example</a></li></ul></li><li><a href="#advanced-examples" class="table-of-contents__link toc-highlight">Advanced Examples</a><ul><li><a href="#counting-likes-and-comments-for-only-current-user" class="table-of-contents__link toc-highlight">Counting Likes and Comments for only current user</a></li><li><a href="#get-total-likes-and-check-if-current-user-liked-the-post" class="table-of-contents__link toc-highlight">Get total likes and check if current user liked the post</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 mentoor.io, Inc.</div></div></div></footer></div>
</body>
</html>